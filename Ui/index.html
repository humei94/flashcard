<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK 3 Pro Flashcard (Stroke Order)</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

    <style>
        /* --- Styles (Chinese Theme + Audio + Strokes) --- */
        body {
            font-family: 'Sarabun', 'Noto Sans SC', sans-serif;
            background-color: #f3e9d2; 
            background-image: radial-gradient(#d6c6a8 2px, transparent 2px);
            background-size: 24px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            color: #4a4a4a;
            user-select: none;
        }

        h1 {
            color: #8b0000;
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: bold;
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
            letter-spacing: 2px;
        }

        .card-container {
            width: 420px;
            height: 600px;
            perspective: 1200px;
            margin-bottom: 20px;
            position: relative;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.7s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(139, 0, 0, 0.2);
            border-radius: 20px;
        }

        .card.is-flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            background: #fff;
            border: 8px double #8b0000;
        }

        /* --- Buttons --- */
        .icon-btn {
            position: absolute;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #8b0000;
            background: rgba(255, 255, 255, 0.9);
            color: #8b0000;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .icon-btn:hover { background: #8b0000; color: #ffd700; transform: scale(1.1); }
        .icon-btn:active { transform: scale(0.95); }

        .btn-audio { top: 20px; left: 20px; }
        .btn-stroke { top: 20px; left: 75px; } /* ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏±‡∏î‡∏°‡∏≤ */
        .btn-star { 
            top: 20px; right: 20px; 
            border: none; background: none; box-shadow: none; font-size: 40px; color: #e0e0e0;
        }
        .btn-star:hover { background: none; box-shadow: none; }
        .btn-star.active { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); transform: scale(1.2); }

        /* --- Front Content --- */
        .card-front {
            background-color: #fffbf0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d00000' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .hanzi-lg {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 110px;
            color: #8b0000;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            transition: opacity 0.3s;
        }

        /* Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏µ‡∏î */
        #stroke-container {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
            flex-direction: row;
            gap: 10px;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.5);
            padding: 10px;
            border-radius: 10px;
        }
        .stroke-char {
            border: 1px solid #d6c6a8;
            background: white;
        }

        .tap-hint {
            font-size: 16px; color: #a67c52; margin-top: 50px;
            border-top: 1px solid #d6c6a8; padding-top: 10px; width: 60%; text-align: center;
        }

        /* --- Back Content --- */
        .card-back {
            background: linear-gradient(145deg, #8b0000 0%, #600000 100%);
            color: #fff; transform: rotateY(180deg);
            align-items: flex-start; text-align: left; overflow-y: auto; border-color: #d4af37;
        }
        .card-back::-webkit-scrollbar { width: 6px; }
        .card-back::-webkit-scrollbar-thumb { background: rgba(255,215,0,0.3); border-radius: 3px; }

        .header-group { width: 100%; border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding-bottom: 15px; margin-bottom: 20px; }
        .pinyin { font-size: 32px; color: #ffd700; font-weight: 500; letter-spacing: 1px; }
        .meaning { font-size: 26px; font-weight: bold; margin-top: 8px; color: #fff; }
        .type-tag { display: inline-block; background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.5); padding: 4px 10px; border-radius: 6px; font-size: 14px; margin-top: 8px; color: #ffd700; }
        .section-title { font-size: 14px; color: #cca4a4; margin-bottom: 8px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; }
        .section-title::before { content: '‚ú¶'; margin-right: 5px; color: #ffd700; }
        .example-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; width: 100%; margin-bottom: 10px; border-left: 4px solid #ffd700; }
        .ex-cn { font-size: 20px; color: #fff; margin-bottom: 6px; font-weight: 400; line-height: 1.5; }
        .ex-th { font-size: 16px; color: #ddd; font-style: italic; }
        .note-box { font-size: 15px; color: #fff; line-height: 1.6; background: rgba(0, 0, 0, 0.2); padding: 10px 15px; border-radius: 10px; width: 100%; }

        /* --- Controls --- */
        .controls { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .nav-btn {
            background: #8b0000; color: #ffd700; border: 2px solid #8b0000; padding: 12px 25px;
            border-radius: 50px; cursor: pointer; transition: all 0.2s; font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .nav-btn:hover { background: #a50000; transform: translateY(-2px); }
        .progress {
            font-weight: 600; color: #8b0000; font-size: 18px; min-width: 90px; text-align: center;
            background: white; padding: 5px 15px; border-radius: 20px; border: 1px solid #d6c6a8;
        }

        .menu-bar { margin-top: 25px; display: flex; gap: 12px; }
        .mode-btn {
            padding: 10px 20px; border: 2px solid #a67c52; background: white; color: #5d4037;
            border-radius: 10px; cursor: pointer; font-family: 'Sarabun', sans-serif; font-weight: 600; font-size: 15px; transition: all 0.2s;
        }
        .mode-btn:hover { background: #fdf5e6; }
        .mode-btn.active { background: #8b0000; color: #ffd700; border-color: #8b0000; }
        .mode-btn.shuffle-active { background: #1e3a8a; color: white; border-color: #1e3a8a; }

    </style>
</head>
<body>

    <h1 id="mode-title">HSK 3 Flashcards</h1>

    <div class="card-container">
        <button class="icon-btn btn-audio" title="‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á" onclick="playAudio(event)">üîä</button>
        <button class="icon-btn btn-stroke" title="‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏µ‡∏î" onclick="playStroke(event)">üñåÔ∏è</button>
        <button class="icon-btn btn-star" id="star-btn" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å" onclick="toggleHard(event)">‚òÖ</button>

        <div class="card" id="flashcard" onclick="flipCard()">
            <div class="card-face card-front">
                <div class="hanzi-lg" id="front-hanzi">...</div>
                <div id="stroke-container"></div>
                
                <div class="tap-hint">(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢)</div>
            </div>

            <div class="card-face card-back">
                <div class="header-group">
                    <div class="pinyin" id="back-pinyin">...</div>
                    <div class="meaning" id="back-meaning">...</div>
                    <span class="type-tag" id="back-type">...</span>
                </div>
                <div class="section-title">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</div>
                <div class="example-box">
                    <div class="ex-cn" id="back-ex-cn">...</div>
                    <div class="ex-th" id="back-ex-th">...</div>
                </div>
                <div id="note-section" style="display:none; width: 100%;">
                    <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï / ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</div>
                    <div class="note-box" id="back-note">...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="nav-btn" onclick="prevCard()">&#10094;</button>
        <span class="progress" id="progress-text">0 / 0</span>
        <button class="nav-btn" onclick="nextCard()">&#10095;</button>
    </div>

    <div class="menu-bar">
        <button class="mode-btn active" id="btn-all" onclick="setMode('all')">üìú ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="mode-btn" id="btn-shuffle" onclick="setMode('shuffle')">üîÄ ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥</button>
        <button class="mode-btn" id="btn-hard" onclick="setMode('hard')">‚≠ê ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (<span id="hard-count">0</span>)</button>
    </div>

    <script>
        // --- Variables ---
        let allWords = [];
        let currentDeck = [];
        let currentIndex = 0;
        let hardList = [];
        let currentMode = 'all';
        let writers = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô HanziWriter

        const els = {
            card: document.getElementById('flashcard'),
            hanzi: document.getElementById('front-hanzi'),
            strokeContainer: document.getElementById('stroke-container'),
            pinyin: document.getElementById('back-pinyin'),
            meaning: document.getElementById('back-meaning'),
            type: document.getElementById('back-type'),
            exCn: document.getElementById('back-ex-cn'),
            exTh: document.getElementById('back-ex-th'),
            note: document.getElementById('back-note'),
            noteSection: document.getElementById('note-section'),
            progress: document.getElementById('progress-text'),
            starBtn: document.getElementById('star-btn'),
            hardCount: document.getElementById('hard-count'),
            modeTitle: document.getElementById('mode-title')
        };

        // --- Init ---
        async function loadData() {
            try {
                const res = await fetch('words.json');
                allWords = await res.json();
                const savedHard = localStorage.getItem('hsk3_hard_words');
                if (savedHard) hardList = JSON.parse(savedHard);
                setMode('all');
                updateHardCount();
            } catch (err) {
                console.error(err);
                els.hanzi.innerText = "Error";
            }
        }

        // --- Logic ---
        function setMode(mode) {
            currentMode = mode;
            currentIndex = 0;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active', 'shuffle-active'));

            if (mode === 'all') {
                currentDeck = [...allWords];
                document.getElementById('btn-all').classList.add('active');
                els.modeTitle.innerText = "HSK 3 : ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
            } else if (mode === 'shuffle') {
                currentDeck = [...allWords];
                for (let i = currentDeck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]];
                }
                document.getElementById('btn-shuffle').classList.add('shuffle-active');
                els.modeTitle.innerText = "HSK 3 : ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå";
            } else if (mode === 'hard') {
                currentDeck = allWords.filter(word => hardList.includes(word.hanzi));
                document.getElementById('btn-hard').classList.add('active');
                els.modeTitle.innerText = "HSK 3 : ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                if (currentDeck.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); setMode('all'); return; }
            }
            renderCard();
        }

        function renderCard() {
            if (!currentDeck.length) return;
            
            // Reset Stroke View
            els.hanzi.style.display = 'block';
            els.strokeContainer.style.display = 'none';
            els.strokeContainer.innerHTML = '';
            
            const item = currentDeck[currentIndex];
            els.hanzi.innerText = item.hanzi;
            els.pinyin.innerText = item.pinyin;
            els.meaning.innerText = item.meaning;
            els.type.innerText = item.type || "";
            els.exCn.innerText = item.example_cn || "-";
            els.exTh.innerText = item.example_th || "";

            if (item.note) {
                els.noteSection.style.display = "block";
                els.note.innerHTML = item.note;
            } else { els.noteSection.style.display = "none"; }

            els.progress.innerText = `${currentIndex + 1} / ${currentDeck.length}`;
            
            if (hardList.includes(item.hanzi)) els.starBtn.classList.add('active');
            else els.starBtn.classList.remove('active');
        }

        // --- Stroke Order Logic (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
        function playStroke(e) {
            e.stopPropagation();
            
            // ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î: ‡∏ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á Animation ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á Text ‡∏õ‡∏Å‡∏ï‡∏¥
            if (els.strokeContainer.style.display === 'flex') {
                els.strokeContainer.style.display = 'none';
                els.hanzi.style.display = 'block';
                return;
            }

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏™‡∏î‡∏á Animation
            const text = currentDeck[currentIndex].hanzi;
            els.hanzi.style.display = 'none';
            els.strokeContainer.style.display = 'flex';
            els.strokeContainer.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
            writers = []; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï array

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Writer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
            for (let i = 0; i < text.length; i++) {
                const charDiv = document.createElement('div');
                charDiv.classList.add('stroke-char');
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ID ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
                const uniqueId = `char-${Date.now()}-${i}`;
                charDiv.id = uniqueId;
                els.strokeContainer.appendChild(charDiv);

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢)
                let size = 120;
                if (text.length > 3) size = 80;

                const writer = HanziWriter.create(uniqueId, text[i], {
                    width: size,
                    height: size,
                    padding: 5,
                    strokeColor: '#8b0000', // ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô
                    outlineColor: '#ddd',   // ‡∏™‡∏µ‡∏£‡πà‡∏≤‡∏á
                    drawingWidth: 4,        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÄ‡∏™‡πâ‡∏ô
                    showOutline: true
                });
                writers.push(writer);
            }

            // ‡πÄ‡∏£‡∏¥‡πà‡∏° Animation ‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß (Sequential Animation)
            animateSequence(0);
        }

        function animateSequence(index) {
            if (index < writers.length) {
                writers[index].animateCharacter({
                    onComplete: function() {
                        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÑ‡∏õ‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        setTimeout(() => animateSequence(index + 1), 200);
                    }
                });
            }
        }

        // --- Audio Logic ---
        function playAudio(e) {
            if(e) e.stopPropagation();
            if (!currentDeck.length) return;
            const text = currentDeck[currentIndex].hanzi;
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            } else { alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á"); }
        }

        // --- Basic Controls ---
        function toggleHard(e) {
            e.stopPropagation();
            const wordKey = currentDeck[currentIndex].hanzi;
            if (hardList.includes(wordKey)) {
                hardList = hardList.filter(h => h !== wordKey);
                els.starBtn.classList.remove('active');
            } else {
                hardList.push(wordKey);
                els.starBtn.classList.add('active');
            }
            localStorage.setItem('hsk3_hard_words', JSON.stringify(hardList));
            updateHardCount();
        }

        function updateHardCount() { els.hardCount.innerText = hardList.length; }
        function flipCard() { els.card.classList.toggle('is-flipped'); }
        
        function nextCard() {
            if (els.card.classList.contains('is-flipped')) {
                els.card.classList.remove('is-flipped');
                setTimeout(() => changeIndex(1), 300);
            } else { changeIndex(1); }
        }
        function prevCard() {
            if (els.card.classList.contains('is-flipped')) {
                els.card.classList.remove('is-flipped');
                setTimeout(() => changeIndex(-1), 300);
            } else { changeIndex(-1); }
        }
        function changeIndex(dir) {
            currentIndex += dir;
            if (currentIndex >= currentDeck.length) currentIndex = 0;
            if (currentIndex < 0) currentIndex = currentDeck.length - 1;
            renderCard();
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === "ArrowRight") nextCard();
            if (e.key === "ArrowLeft") prevCard();
            if (e.key === "Enter") flipCard();
            if (e.key === " ") { e.preventDefault(); playAudio(); }
        });

        loadData();
    </script>
</body>
</html>