<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK 3 Ultimate Learning (Font Toggle)</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

    <style>
        /* --- Core Layout --- */
        body {
            font-family: 'Sarabun', 'Noto Sans SC', sans-serif;
            background-color: #f3e9d2; 
            background-image: radial-gradient(#d6c6a8 2px, transparent 2px);
            background-size: 24px 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; color: #4a4a4a; user-select: none;
        }

        .app-wrapper {
            display: flex; align-items: center; gap: 40px;
        }

        h1 {
            color: #8b0000; font-family: 'Noto Sans SC', sans-serif; font-weight: bold;
            font-size: 32px; margin-bottom: 20px; text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
            letter-spacing: 2px;
        }

        /* --- Card --- */
        .card-container {
            width: 520px; height: 720px; perspective: 1200px; position: relative;
        }
        .card {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d; cursor: pointer;
            box-shadow: 0 20px 50px rgba(139, 0, 0, 0.15); border-radius: 30px;
        }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 30px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 30px;
            box-sizing: border-box; background: #fff; border: 10px double #8b0000;
        }

        /* --- Sidebar Stats --- */
        .sidebar {
            width: 280px; background: rgba(255, 255, 255, 0.9); border: 2px solid #8b0000;
            border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 15px;
        }
        .sidebar-title { font-size: 20px; font-weight: bold; color: #8b0000; text-align: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 5px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 16px; color: #555; }
        .stat-val { font-weight: bold; font-size: 20px; }
        .streak-box { background: #fff3e0; border: 1px solid #ffe0b2; border-radius: 10px; padding: 15px; text-align: center; margin-bottom: 10px; }
        .streak-fire { font-size: 30px; }
        .shortcut-hint { margin-top: 20px; font-size: 12px; color: #888; border-top: 1px solid #eee; padding-top: 10px; }
        .key { display: inline-block; background: #eee; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: bold; font-size: 11px; margin: 0 2px; }

        /* --- Buttons --- */
        .icon-btn {
            position: absolute; width: 50px; height: 50px; border-radius: 50%;
            border: 2px solid #8b0000; background: rgba(255, 255, 255, 0.95);
            color: #8b0000; font-size: 22px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; z-index: 20; transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .icon-btn:hover { background: #8b0000; color: #ffd700; transform: scale(1.1); }
        
        .btn-audio { top: 25px; left: 25px; }
        .btn-stroke { top: 25px; left: 85px; } 
        .btn-write { top: 25px; left: 145px; border-color: #d35400; color: #d35400; }
        .btn-font { top: 25px; left: 205px; border-color: #34495e; color: #34495e; font-weight: bold; font-size: 18px; } /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
        
        .btn-star { top: 20px; right: 25px; border: none; background: none; box-shadow: none; font-size: 45px; color: #e0e0e0; }
        .btn-star.active { color: #ffd700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.8); transform: scale(1.2); }
        .btn-quiz { top: 25px; right: 80px; }
        .btn-mic { top: 25px; right: 140px; }

        /* --- Front & Back --- */
        .card-front {
            background-color: #fffbf0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d00000' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2v4h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .hanzi-lg { 
            font-family: 'Ma Shan Zheng', cursive; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô) */
            font-size: 140px; color: #8b0000; margin-bottom: 30px; 
            text-shadow: 3px 3px 0px rgba(0,0,0,0.1); 
            transition: font-family 0.3s;
        }
        
        /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏õ‡∏Å‡∏ï‡∏¥ */
        .hanzi-lg.normal-font {
            font-family: 'Noto Sans SC', sans-serif !important;
            font-weight: bold;
        }

        #stroke-container { 
            display: none; flex-direction: row; gap: 10px; justify-content: center; align-items: center; 
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; border: 1px solid #d6c6a8; cursor: auto;
        }
        .stroke-char { border: 1px solid #d6c6a8; background: white; }
        .tap-hint { font-size: 18px; color: #a67c52; margin-top: 60px; border-top: 1px solid #d6c6a8; padding-top: 15px; width: 70%; text-align: center; }

        .card-back { background: linear-gradient(145deg, #8b0000 0%, #600000 100%); color: #fff; transform: rotateY(180deg); alignItems: flex-start; textAlign: left; overflow-y: auto; border-color: #d4af37; }
        .card-back::-webkit-scrollbar { width: 8px; }
        .card-back::-webkit-scrollbar-thumb { background: rgba(255,215,0,0.3); border-radius: 4px; }
        .header-group { width: 100%; border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding-bottom: 15px; margin-bottom: 25px; }
        .pinyin { font-size: 36px; color: #ffd700; font-weight: 500; letter-spacing: 1px; }
        .meaning { font-size: 30px; font-weight: bold; margin-top: 10px; color: #fff; }
        .type-tag { display: inline-block; background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.5); padding: 5px 12px; border-radius: 6px; font-size: 16px; margin-top: 10px; color: #ffd700; }
        .section-title { font-size: 16px; color: #cca4a4; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; }
        .section-title::before { content: '‚ú¶'; margin-right: 5px; color: #ffd700; }
        .example-box { background: rgba(255,255,255,0.1); padding: 18px; border-radius: 12px; width: 100%; margin-bottom: 10px; border-left: 5px solid #ffd700; }
        .ex-cn { font-size: 24px; color: #fff; margin-bottom: 8px; font-weight: 400; line-height: 1.5; }
        .ex-th { font-size: 18px; color: #ddd; font-style: italic; }
        .note-box { font-size: 16px; color: #fff; line-height: 1.6; background: rgba(0, 0, 0, 0.2); padding: 12px 18px; border-radius: 10px; width: 100%; }

        /* Controls */
        .controls-area { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px; }
        .nav-controls { display: flex; align-items: center; gap: 20px; }
        .nav-btn { background: #8b0000; color: #ffd700; border: 2px solid #8b0000; padding: 12px 30px; border-radius: 50px; cursor: pointer; transition: all 0.2s; font-size: 22px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .nav-btn:hover { background: #a50000; transform: translateY(-2px); }
        .progress { font-weight: 600; color: #8b0000; font-size: 20px; min-width: 100px; text-align: center; background: white; padding: 8px 20px; border-radius: 20px; border: 1px solid #d6c6a8; }
        
        #srs-controls { display: none; gap: 20px; margin-top: 10px; }
        .srs-btn { padding: 15px 40px; border-radius: 50px; font-size: 20px; font-weight: bold; cursor: pointer; border: none; transition: transform 0.2s; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .srs-btn:hover { transform: scale(1.05); }
        .srs-again { background-color: #e74c3c; }
        .srs-good { background-color: #27ae60; }

        .mode-bar { display: flex; gap: 10px; margin-top: 10px; }
        .mode-btn { padding: 10px 20px; border: 2px solid #a67c52; background: white; color: #5d4037; border-radius: 10px; cursor: pointer; font-family: 'Sarabun', sans-serif; font-weight: 600; font-size: 16px; transition: all 0.2s; }
        .mode-btn:hover { background: #fdf5e6; }
        .mode-btn.active { background: #8b0000; color: #ffd700; border-color: #8b0000; }
        .mode-btn.shuffle-active { background: #1e3a8a; color: white; border-color: #1e3a8a; }
        .mode-btn.srs-active { background: #8e44ad; color: white; border-color: #8e44ad; }

        .search-btn-float { position: fixed; top: 20px; left: 20px; background: white; border: 1px solid #8b0000; color: #8b0000; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Overlays */
        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 50; border-radius: 30px; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 30px; background: none; border: none; cursor: pointer; color: #888; }
        .quiz-question { font-family: 'Ma Shan Zheng', cursive; font-size: 100px; color: #8b0000; margin-bottom: 30px; }
        .quiz-options { display: grid; grid-template-columns: 1fr; gap: 15px; width: 90%; }
        .option-btn { padding: 18px; font-size: 20px; background: white; border: 2px solid #d6c6a8; border-radius: 15px; cursor: pointer; color: #5d4037; font-family: 'Sarabun'; transition: all 0.2s; }
        .option-btn:hover { background: #fdf5e6; border-color: #8b0000; }
        .option-btn.correct { background-color: #2ecc71 !important; color: white; border-color: #27ae60; }
        .option-btn.wrong { background-color: #e74c3c !important; color: white; border-color: #c0392b; }
        #mic-result { font-size: 50px; color: #333; margin-bottom: 30px; font-family: 'Ma Shan Zheng'; min-height: 70px;}
        .mic-icon-large { font-size: 80px; color: #e74c3c; animation: pulse 1.5s infinite; margin-bottom: 20px;}
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* Search Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 600px; height: 80%; border-radius: 20px; padding: 25px; position: relative; display: flex; flex-direction: column; }
        #search-input { padding: 15px; font-size: 20px; border: 2px solid #d6c6a8; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 15px; font-family: 'Sarabun'; }
        #search-results { flex: 1; overflow-y: auto; }
        .search-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 18px;}
        .search-item:hover { background: #f9f9f9; }

    </style>
</head>
<body>

    <button class="search-btn-float" onclick="openSearch()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏®‡∏±‡∏û‡∏ó‡πå</button>

    <h1>HSK 3 Ultimate</h1>

    <div class="app-wrapper">
        
        <div>
            <div class="card-container">
                <button class="icon-btn btn-audio" title="Spacebar" onclick="playAudio(event)">üîä</button>
                <button class="icon-btn btn-stroke" title="Press 'S'" onclick="playStroke(event)">üëÄ</button>
                <button class="icon-btn btn-write" title="Press 'W'" onclick="playHandwriting(event)">üñåÔ∏è</button>
                <button class="icon-btn btn-font" title="Press 'N' (Normal Font)" onclick="toggleFont(event)">Aa</button> <button class="icon-btn btn-mic" title="Press 'V'" onclick="startMic(event)">üé§</button>
                <button class="icon-btn btn-quiz" title="Press 'Q'" onclick="startQuiz(event)">üéÆ</button>
                <button class="icon-btn btn-star" id="star-btn" title="Press 'F'" onclick="toggleHard(event)">‚òÖ</button>

                <div id="quiz-overlay" class="overlay-screen">
                    <button class="close-btn" onclick="closeOverlay('quiz-overlay')">‚úï</button>
                    <div class="quiz-question" id="quiz-q">...</div>
                    <div class="quiz-options" id="quiz-options"></div>
                    <div style="margin-top:20px; font-size: 20px; color: #666;" id="quiz-status"></div>
                </div>

                <div id="mic-overlay" class="overlay-screen">
                    <button class="close-btn" onclick="stopMic()">‚úï</button>
                    <div class="mic-icon-large">üé§</div>
                    <div id="mic-status" style="font-size:24px; color:#8b0000; font-weight:bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...</div>
                    <div id="mic-result">...</div>
                    <div style="color:#666; font-size:18px;">‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤: <span id="target-word" style="color:#8b0000; font-weight:bold;">...</span></div>
                </div>

                <div class="card" id="flashcard" onclick="flipCard()">
                    <div class="card-face card-front">
                        <div class="hanzi-lg" id="front-hanzi">...</div>
                        <div id="stroke-container" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"></div>
                        <div class="tap-hint" id="front-hint">(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢)</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="header-group">
                            <div class="pinyin" id="back-pinyin">...</div>
                            <div class="meaning" id="back-meaning">...</div>
                            <span class="type-tag" id="back-type">...</span>
                        </div>
                        <div class="section-title">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</div>
                        <div class="example-box">
                            <div class="ex-cn" id="back-ex-cn">...</div>
                            <div class="ex-th" id="back-ex-th">...</div>
                        </div>
                        <div id="note-section" style="display:none; width: 100%;">
                            <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï / ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</div>
                            <div class="note-box" id="back-note">...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-area">
                <div class="nav-controls" id="normal-controls">
                    <button class="nav-btn" onclick="prevCard()">&#10094;</button>
                    <span class="progress" id="progress-text">0 / 0</span>
                    <button class="nav-btn" onclick="nextCard()">&#10095;</button>
                </div>
                <div id="srs-controls">
                    <button class="srs-btn srs-again" onclick="rateCard(false)">‚ùå ‡∏•‡∏∑‡∏°</button>
                    <button class="srs-btn srs-good" onclick="rateCard(true)">‚úÖ ‡∏à‡∏≥‡πÑ‡∏î‡πâ</button>
                </div>
                
                <div class="mode-bar">
                    <button class="mode-btn active" id="btn-all" onclick="setMode('all')">üìú ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button class="mode-btn" id="btn-shuffle" onclick="setMode('shuffle')">üîÄ ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥</button>
                    <button class="mode-btn" id="btn-hard" onclick="setMode('hard')">‚≠ê ‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å</button>
                    <button class="mode-btn" id="btn-srs" onclick="setMode('srs')">üß† Review</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
            
            <div class="streak-box">
                <div class="streak-fire">üî•</div>
                <div style="font-size:24px; font-weight:bold; color:#d35400;" id="side-streak">0</div>
                <div style="font-size:12px;">‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
            </div>

            <div class="stat-row">
                <span>üü¢ ‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô</span>
                <span class="stat-val" style="color:#27ae60;" id="side-master">0</span>
            </div>
            <div class="stat-row">
                <span>üü† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                <span class="stat-val" style="color:#f39c12;" id="side-learning">0</span>
            </div>
            <div class="stat-row">
                <span>‚ö™ ‡∏Ñ‡∏≥‡πÉ‡∏´‡∏°‡πà</span>
                <span class="stat-val" style="color:#7f8c8d;" id="side-new">0</span>
            </div>
            <div class="stat-row">
                <span>üî¥ ‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å (‡∏î‡∏≤‡∏ß)</span>
                <span class="stat-val" style="color:#e74c3c;" id="side-hard">0</span>
            </div>

            <div class="shortcut-hint">
                <div><span class="key">Space</span> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
                <div><span class="key">Enter</span> ‡∏û‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î</div>
                <div><span class="key">‚Üê</span> <span class="key">‚Üí</span> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥</div>
                <div><span class="key">W</span> ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô &nbsp; <span class="key">S</span> ‡∏Ç‡∏µ‡∏î &nbsp; <span class="key">N</span> ‡∏ü‡∏≠‡∏ô‡∏ï‡πå</div>
                <div><span class="key">V</span> ‡∏û‡∏π‡∏î &nbsp; <span class="key">Q</span> ‡πÄ‡∏Å‡∏° &nbsp; <span class="key">F</span> ‡∏î‡∏≤‡∏ß</div>
            </div>
            <button class="mode-btn" onclick="createSettingsMenu()" style="margin-top:auto;">‚öôÔ∏è ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

    </div>

    <div id="search-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeOverlay('search-modal')" style="right:10px; top:10px;">‚úï</button>
            <div style="font-size:22px; font-weight:bold; color:#8b0000; margin-bottom:15px;">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°</div>
            <input type="text" id="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏µ‡∏ô, ‡∏û‡∏¥‡∏ô‡∏≠‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏ó‡∏¢..." onkeyup="handleSearch()">
            <div id="search-results"></div>
        </div>
    </div>

    <script>
        // --- DATA SECTION ---
        let allWords = []; 
        let currentDeck = []; let currentIndex = 0;
        let hardList = []; let srsData = {}; let currentMode = 'all';
        let recognition; let writers = [];
        let studyStats = { streak: 0, lastDate: "" };
        let isNormalFont = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏ô‡∏ï‡πå

        const els = {
            card: document.getElementById('flashcard'),
            hanzi: document.getElementById('front-hanzi'),
            strokeContainer: document.getElementById('stroke-container'),
            pinyin: document.getElementById('back-pinyin'),
            meaning: document.getElementById('back-meaning'),
            type: document.getElementById('back-type'),
            exCn: document.getElementById('back-ex-cn'),
            exTh: document.getElementById('back-ex-th'),
            note: document.getElementById('back-note'),
            noteSection: document.getElementById('note-section'),
            progress: document.getElementById('progress-text'),
            starBtn: document.getElementById('star-btn'),
            modeTitle: document.getElementById('mode-title'),
            frontHint: document.getElementById('front-hint'),
            normalControls: document.getElementById('normal-controls'),
            srsControls: document.getElementById('srs-controls'),
            // Overlays
            quizOverlay: document.getElementById('quiz-overlay'),
            micOverlay: document.getElementById('mic-overlay'),
            searchModal: document.getElementById('search-modal'),
            // Side Stats
            sideStreak: document.getElementById('side-streak'),
            sideMaster: document.getElementById('side-master'),
            sideLearning: document.getElementById('side-learning'),
            sideNew: document.getElementById('side-new'),
            sideHard: document.getElementById('side-hard')
        };

        // --- Init ---
        async function loadData() {
            try {
                // *** ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Live Server ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ fetch('words.json') ***
                // *** ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏°‡∏≤‡πÅ‡∏õ‡∏∞‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ allWords ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏ó‡∏ô ***
                const res = await fetch('words.json');
                allWords = await res.json();
                
                // Load saved data
                if(localStorage.getItem('hsk3_hard')) hardList = JSON.parse(localStorage.getItem('hsk3_hard'));
                if(localStorage.getItem('hsk3_srs')) srsData = JSON.parse(localStorage.getItem('hsk3_srs'));
                if(localStorage.getItem('hsk3_stats')) studyStats = JSON.parse(localStorage.getItem('hsk3_stats'));

                checkStreak();
                setMode('all');
                updateStatsUI();
            } catch (err) { 
                console.error(err); 
                els.hanzi.innerText = "Error"; 
            }
        }

        function checkStreak() {
            const today = new Date().toDateString();
            if (studyStats.lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (studyStats.lastDate === yesterday.toDateString()) { studyStats.streak++; } 
                else { studyStats.streak = 1; }
                studyStats.lastDate = today;
                localStorage.setItem('hsk3_stats', JSON.stringify(studyStats));
            }
        }

        function updateStatsUI() {
            let master = 0, learning = 0, newWords = 0;
            allWords.forEach(w => {
                const d = srsData[w.hanzi];
                if (!d) newWords++; else if (d.level >= 4) master++; else learning++;
            });
            els.sideStreak.innerText = studyStats.streak;
            els.sideMaster.innerText = master;
            els.sideLearning.innerText = learning;
            els.sideNew.innerText = newWords;
            els.sideHard.innerText = hardList.length;
        }

        // --- Mode Logic ---
        function setMode(mode) {
            currentMode = mode; currentIndex = 0;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active', 'srs-active', 'shuffle-active'));
            els.normalControls.style.display = 'flex'; els.srsControls.style.display = 'none';
            els.frontHint.innerText = "(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢)";

            if (mode === 'all') {
                currentDeck = [...allWords];
                document.getElementById('btn-all').classList.add('active');
            } else if (mode === 'shuffle') {
                currentDeck = [...allWords];
                for (let i = currentDeck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]];
                }
                document.getElementById('btn-shuffle').classList.add('shuffle-active');
            } else if (mode === 'hard') {
                currentDeck = allWords.filter(word => hardList.includes(word.hanzi));
                document.getElementById('btn-hard').classList.add('active');
                if (!currentDeck.length) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å"); setMode('all'); return; }
            } else if (mode === 'srs') {
                const now = Date.now();
                currentDeck = allWords.filter(w => { const d = srsData[w.hanzi]; return !d || d.nextReview <= now; });
                document.getElementById('btn-srs').classList.add('srs-active');
                if (!currentDeck.length) { alert("‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!"); setMode('all'); return; }
                currentDeck.sort(() => Math.random() - 0.5);
                els.normalControls.style.display = 'none';
                els.frontHint.innerText = "(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏•‡∏¢)";
            }
            renderCard();
        }

        function renderCard() {
            if (!currentDeck.length) return;
            els.card.classList.remove('is-flipped');
            els.hanzi.style.display = 'block';
            els.strokeContainer.style.display = 'none';
            els.strokeContainer.innerHTML = '';
            
            const item = currentDeck[currentIndex];
            els.hanzi.innerText = item.hanzi;
            
            // Apply Font
            if(isNormalFont) els.hanzi.classList.add('normal-font');
            else els.hanzi.classList.remove('normal-font');

            els.pinyin.innerText = item.pinyin;
            els.meaning.innerText = item.meaning;
            els.type.innerText = item.type || "";
            els.exCn.innerText = item.example_cn || "-";
            els.exTh.innerText = item.example_th || "";
            if (item.note) { els.noteSection.style.display = 'block'; els.note.innerHTML = item.note; } 
            else els.noteSection.style.display = 'none';

            els.progress.innerText = `${currentIndex + 1} / ${currentDeck.length}`;
            if (hardList.includes(item.hanzi)) els.starBtn.classList.add('active');
            else els.starBtn.classList.remove('active');
        }

        // --- Features ---
        function toggleFont(e) {
            if(e) e.stopPropagation();
            isNormalFont = !isNormalFont;
            renderCard();
        }

        function playHandwriting(e) { e.stopPropagation(); setupWriter(true); }
        function playStroke(e) { e.stopPropagation(); setupWriter(false); }
        function setupWriter(isQuiz) {
            if (els.strokeContainer.style.display === 'flex') {
                els.strokeContainer.style.display = 'none'; els.hanzi.style.display = 'block'; return;
            }
            const text = currentDeck[currentIndex].hanzi;
            els.hanzi.style.display = 'none';
            els.strokeContainer.style.display = 'flex';
            els.strokeContainer.innerHTML = '';
            writers = [];
            for (let i = 0; i < text.length; i++) {
                const div = document.createElement('div');
                div.className = 'stroke-char'; div.id = `char-${i}`;
                els.strokeContainer.appendChild(div);
                let size = 130; if (text.length > 3) size = 80;
                const writer = HanziWriter.create(div.id, text[i], {
                    width: size, height: size, padding: 5, strokeColor: '#8b0000', showOutline: true, drawingWidth: 4
                });
                writers.push(writer);
            }
            if (isQuiz) quizSequence(0); else animateSequence(0);
        }
        function animateSequence(index) {
            if (index < writers.length) { writers[index].animateCharacter({ onComplete: () => setTimeout(() => animateSequence(index + 1), 200) }); }
        }
        function quizSequence(index) {
            if (index < writers.length) { writers[index].quiz({ onComplete: () => setTimeout(() => quizSequence(index + 1), 300) }); }
        }

        function playAudio(e) {
            if(e) e.stopPropagation();
            if (!currentDeck.length) return;
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(currentDeck[currentIndex].hanzi);
                u.lang = 'zh-CN'; u.rate = 0.8; window.speechSynthesis.speak(u);
            }
        }

        function startMic(e) {
            e.stopPropagation();
            if (!currentDeck.length) return;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á"); return; }
            els.micOverlay.style.display = 'flex';
            const target = currentDeck[currentIndex].hanzi;
            document.getElementById('target-word').innerText = target;
            document.getElementById('mic-status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
            document.getElementById('mic-status').style.color = "#8b0000";
            document.getElementById('mic-result').innerText = "...";
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; recognition.start();
            recognition.onresult = (ev) => {
                const res = ev.results[0][0].transcript.replace(/[„ÄÇÔºåÔºÅÔºü]/g, "");
                document.getElementById('mic-result').innerText = res;
                if (res === target) {
                    document.getElementById('mic-status').innerText = "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! üéâ";
                    document.getElementById('mic-status').style.color = "#27ae60";
                    setTimeout(() => { stopMic(); nextCard(); }, 1500);
                } else {
                    document.getElementById('mic-status').innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
                    setTimeout(() => { recognition.start(); }, 1500);
                }
            };
            recognition.onspeechend = () => recognition.stop();
        }
        function stopMic() { if(recognition) recognition.stop(); els.micOverlay.style.display = 'none'; }

        function startQuiz(e) { e.stopPropagation(); els.quizOverlay.style.display = 'flex'; generateQuiz(); }
        function closeOverlay(id) { document.getElementById(id).style.display = 'none'; }
        function generateQuiz() {
            const correct = currentDeck[currentIndex];
            document.getElementById('quiz-q').innerText = correct.hanzi;
            document.getElementById('quiz-status').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•";
            const optsDiv = document.getElementById('quiz-options');
            optsDiv.innerHTML = '';
            let opts = [correct];
            while(opts.length < 4) {
                const r = allWords[Math.floor(Math.random()*allWords.length)];
                if(!opts.includes(r) && r.hanzi !== correct.hanzi) opts.push(r);
            }
            opts.sort(()=>Math.random()-0.5);
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = o.meaning;
                btn.onclick = () => {
                    if(o.hanzi === correct.hanzi) {
                        btn.classList.add('correct');
                        document.getElementById('quiz-status').innerText = "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!";
                        playAudio();
                        setTimeout(()=>{ nextCard(); generateQuiz(); }, 1000);
                    } else {
                        btn.classList.add('wrong');
                        setTimeout(() => closeOverlay('quiz-overlay'), 1000);
                    }
                };
                optsDiv.appendChild(btn);
            });
        }

        // --- Controls ---
        function toggleHard(e) {
            e.stopPropagation();
            const key = currentDeck[currentIndex].hanzi;
            if (hardList.includes(key)) hardList = hardList.filter(k=>k!==key);
            else hardList.push(key);
            localStorage.setItem('hsk3_hard', JSON.stringify(hardList));
            updateStatsUI(); renderCard();
        }
        function flipCard() { 
            els.card.classList.toggle('is-flipped');
            if(currentMode==='srs' && els.card.classList.contains('is-flipped')) {
                els.srsControls.style.display='flex'; playAudio();
            }
        }
        function nextCard() { els.card.classList.remove('is-flipped'); setTimeout(() => { changeIndex(1); }, 300); }
        function prevCard() { els.card.classList.remove('is-flipped'); setTimeout(() => { changeIndex(-1); }, 300); }
        function changeIndex(d) { currentIndex += d; if(currentIndex>=currentDeck.length) currentIndex=0; if(currentIndex<0) currentIndex=currentDeck.length-1; renderCard(); }
        function rateCard(isGood) {
            const key = currentDeck[currentIndex].hanzi;
            let d = srsData[key] || { level: 0 };
            if(isGood) { d.level++; d.nextReview = Date.now() + (d.level*24*60*60*1000); }
            else { d.level = 0; d.nextReview = Date.now(); }
            srsData[key] = d; localStorage.setItem('hsk3_srs', JSON.stringify(srsData));
            updateStatsUI(); nextCard();
        }

        // --- Search ---
        function openSearch() { els.searchModal.style.display = 'flex'; document.getElementById('search-input').focus(); }
        function handleSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            if(query.length < 1) return;
            const matches = allWords.filter(w => w.hanzi.includes(query) || w.pinyin.toLowerCase().includes(query) || w.meaning.includes(query)).slice(0, 50);
            matches.forEach(w => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span>${w.hanzi}</span> <span style="font-size:14px;color:#666">${w.meaning}</span>`;
                div.onclick = () => {
                    setMode('all');
                    currentIndex = allWords.findIndex(x => x.hanzi === w.hanzi);
                    renderCard();
                    closeOverlay('search-modal');
                };
                resultsDiv.appendChild(div);
            });
        }

        // --- Settings / Backup ---
        function createSettingsMenu() {
            const action = prompt("‡∏û‡∏¥‡∏°‡∏û‡πå 'save' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• \n‡∏û‡∏¥‡∏°‡∏û‡πå 'load' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            if (action === 'save') exportData();
            if (action === 'load') importData();
        }
        function exportData() {
            const data = { hard: localStorage.getItem('hsk3_hard'), srs: localStorage.getItem('hsk3_srs'), stats: localStorage.getItem('hsk3_stats') };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `hsk3_backup.json`; a.click();
        }
        function importData() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(data.hard) localStorage.setItem('hsk3_hard', data.hard);
                        if(data.srs) localStorage.setItem('hsk3_srs', data.srs);
                        if(data.stats) localStorage.setItem('hsk3_stats', data.stats);
                        alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); location.reload();
                    } catch(err) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            if (els.searchModal.style.display === 'flex') return;

            switch(e.key.toLowerCase()) {
                case "arrowright": nextCard(); break;
                case "arrowleft": prevCard(); break;
                case "enter": flipCard(); break;
                case " ": e.preventDefault(); playAudio(); break;
                case "w": playHandwriting(e); break;
                case "s": playStroke(e); break;
                case "v": startMic(e); break;
                case "q": startQuiz(e); break;
                case "f": toggleHard(e); break;
                case "n": toggleFont(e); break;
            }
        });

        loadData();
    </script>
</body>
</html>