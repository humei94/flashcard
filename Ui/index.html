<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK 3 Ultimate Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

    <style>
        /* --- Core Styles --- */
        body {
            font-family: 'Sarabun', 'Noto Sans SC', sans-serif;
            background-color: #f3e9d2; 
            background-image: radial-gradient(#d6c6a8 2px, transparent 2px);
            background-size: 24px 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; color: #4a4a4a; user-select: none;
        }

        h1 {
            color: #8b0000; font-family: 'Noto Sans SC', sans-serif; font-weight: bold;
            font-size: 24px; margin-bottom: 10px; text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
            letter-spacing: 2px; cursor: pointer;
        }

        /* --- Layout --- */
        .card-container {
            width: 420px; height: 600px; perspective: 1200px; margin-bottom: 20px; position: relative;
        }
        .card {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.7s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d; cursor: pointer;
            box-shadow: 0 15px 35px rgba(139, 0, 0, 0.2); border-radius: 20px;
        }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
            box-sizing: border-box; background: #fff; border: 8px double #8b0000;
        }

        /* --- Buttons --- */
        .icon-btn {
            position: absolute; width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid #8b0000; background: rgba(255, 255, 255, 0.95);
            color: #8b0000; font-size: 18px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; z-index: 20; transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .icon-btn:hover { background: #8b0000; color: #ffd700; transform: scale(1.1); }
        
        /* Left Group */
        .btn-audio { top: 20px; left: 20px; }
        .btn-stroke { top: 20px; left: 70px; } 
        .btn-write { top: 20px; left: 120px; border-color: #d35400; color: #d35400;} /* New: Write */
        
        /* Right Group */
        .btn-star { top: 20px; right: 20px; border: none; background: none; box-shadow: none; font-size: 35px; color: #e0e0e0; }
        .btn-star.active { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); transform: scale(1.2); }
        .btn-quiz { top: 20px; right: 65px; }
        .btn-mic { top: 20px; right: 115px; }

        /* Top Header Buttons (Search & Stats) */
        .header-btn {
            position: fixed; top: 20px; background: white; border: 1px solid #8b0000;
            color: #8b0000; padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-weight: bold; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; z-index: 100;
        }
        .header-btn:hover { background: #8b0000; color: white; }
        .btn-stats { right: 20px; }
        .btn-search { left: 20px; }

        /* --- Front & Back --- */
        .card-front {
            background-color: #fffbf0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d00000' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2v4h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .hanzi-lg { font-family: 'Ma Shan Zheng', cursive; font-size: 110px; color: #8b0000; margin-bottom: 20px; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        
        /* Container for Stroke & Write */
        #stroke-container { display: none; flex-direction: row; gap: 10px; justify-content: center; align-items: center; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 10px; border: 1px solid #d6c6a8; }
        .stroke-char { border: 1px solid #d6c6a8; background: white; }
        
        .tap-hint { font-size: 16px; color: #a67c52; margin-top: 50px; border-top: 1px solid #d6c6a8; padding-top: 10px; width: 60%; text-align: center; }

        .card-back { background: linear-gradient(145deg, #8b0000 0%, #600000 100%); color: #fff; transform: rotateY(180deg); alignItems: flex-start; textAlign: left; overflow-y: auto; border-color: #d4af37; }
        .card-back::-webkit-scrollbar { width: 6px; }
        .card-back::-webkit-scrollbar-thumb { background: rgba(255,215,0,0.3); border-radius: 3px; }
        .header-group { width: 100%; border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding-bottom: 15px; margin-bottom: 20px; }
        .pinyin { font-size: 32px; color: #ffd700; font-weight: 500; letter-spacing: 1px; }
        .meaning { font-size: 26px; font-weight: bold; margin-top: 8px; color: #fff; }
        .type-tag { display: inline-block; background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.5); padding: 4px 10px; border-radius: 6px; font-size: 14px; margin-top: 8px; color: #ffd700; }
        .section-title { font-size: 14px; color: #cca4a4; margin-bottom: 8px; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; }
        .section-title::before { content: '‚ú¶'; margin-right: 5px; color: #ffd700; }
        .example-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; width: 100%; margin-bottom: 10px; border-left: 4px solid #ffd700; }
        .ex-cn { font-size: 20px; color: #fff; margin-bottom: 6px; font-weight: 400; line-height: 1.5; }
        .ex-th { font-size: 16px; color: #ddd; font-style: italic; }
        .note-box { font-size: 15px; color: #fff; line-height: 1.6; background: rgba(0, 0, 0, 0.2); padding: 10px 15px; border-radius: 10px; width: 100%; }

        /* --- Controls & Menu --- */
        .controls { display: flex; align-items: center; gap: 20px; margin-top: 10px; height: 60px;}
        .nav-btn { background: #8b0000; color: #ffd700; border: 2px solid #8b0000; padding: 12px 25px; border-radius: 50px; cursor: pointer; transition: all 0.2s; font-size: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .nav-btn:hover { background: #a50000; transform: translateY(-2px); }
        .progress { font-weight: 600; color: #8b0000; font-size: 18px; min-width: 90px; text-align: center; background: white; padding: 5px 15px; border-radius: 20px; border: 1px solid #d6c6a8; }
        
        #srs-controls { display: none; gap: 15px; }
        .srs-btn { padding: 12px 30px; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; transition: transform 0.2s; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .srs-again { background-color: #e74c3c; }
        .srs-good { background-color: #27ae60; }

        .menu-bar { margin-top: 25px; display: flex; gap: 12px; }
        .mode-btn { padding: 10px 20px; border: 2px solid #a67c52; background: white; color: #5d4037; border-radius: 10px; cursor: pointer; font-family: 'Sarabun', sans-serif; font-weight: 600; font-size: 15px; transition: all 0.2s; }
        .mode-btn:hover { background: #fdf5e6; }
        .mode-btn.active { background: #8b0000; color: #ffd700; border-color: #8b0000; }
        .mode-btn.shuffle-active { background: #1e3a8a; color: white; border-color: #1e3a8a; }
        .mode-btn.srs-active { background: #8e44ad; color: white; border-color: #8e44ad; }

        /* --- Overlays --- */
        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 50; border-radius: 20px; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer; color: #888; }
        
        /* Quiz */
        .quiz-question { font-family: 'Ma Shan Zheng', cursive; font-size: 80px; color: #8b0000; margin-bottom: 30px; }
        .quiz-options { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; }
        .option-btn { padding: 15px; font-size: 18px; background: white; border: 2px solid #d6c6a8; border-radius: 12px; cursor: pointer; color: #5d4037; font-family: 'Sarabun', sans-serif; transition: all 0.2s; }
        .option-btn:hover { background: #fdf5e6; border-color: #8b0000; }
        .option-btn.correct { background-color: #2ecc71 !important; color: white; border-color: #27ae60; }
        .option-btn.wrong { background-color: #e74c3c !important; color: white; border-color: #c0392b; }

        /* Mic */
        #mic-status { font-size: 24px; color: #8b0000; margin-bottom: 20px; font-weight: bold; }
        #mic-result { font-size: 40px; color: #333; margin-bottom: 30px; font-family: 'Ma Shan Zheng'; min-height: 60px;}
        .mic-icon-large { font-size: 60px; color: #e74c3c; animation: pulse 1.5s infinite; margin-bottom: 20px;}
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* --- Full Screen Modals (Search & Stats) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; height: 80%; border-radius: 20px;
            padding: 20px; position: relative; display: flex; flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .modal-header { font-size: 22px; font-weight: bold; color: #8b0000; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* Search */
        #search-input { padding: 12px; font-size: 18px; border: 2px solid #d6c6a8; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 15px; font-family: 'Sarabun'; }
        #search-results { flex: 1; overflow-y: auto; }
        .search-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .search-item:hover { background: #f9f9f9; }
        .search-hanzi { font-size: 20px; color: #8b0000; font-weight: bold; }
        .search-mean { font-size: 14px; color: #666; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #fdf5e6; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #d6c6a8; }
        .stat-num { font-size: 28px; font-weight: bold; color: #8b0000; }
        .stat-label { font-size: 14px; color: #5d4037; }
        .streak-fire { font-size: 40px; margin-bottom: 5px; }

    </style>
</head>
<body>

    <button class="header-btn btn-search" onclick="openSearch()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    <button class="header-btn btn-stats" onclick="openStats()">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>

    <h1 id="mode-title">HSK 3 Ultimate</h1>

    <div class="card-container">
        <button class="icon-btn btn-audio" title="‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á" onclick="playAudio(event)">üîä</button>
        <button class="icon-btn btn-stroke" title="‡∏î‡∏π‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏µ‡∏î (Watch)" onclick="playStroke(event)">üëÄ</button>
        <button class="icon-btn btn-write" title="‡∏ù‡∏∂‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠ (Practice)" onclick="playHandwriting(event)">üñåÔ∏è</button>
        
        <button class="icon-btn btn-mic" title="‡∏ù‡∏∂‡∏Å‡∏û‡∏π‡∏î" onclick="startMic(event)">üé§</button>
        <button class="icon-btn btn-quiz" title="‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏®‡∏±‡∏û‡∏ó‡πå" onclick="startQuiz(event)">üéÆ</button>
        <button class="icon-btn btn-star" id="star-btn" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å" onclick="toggleHard(event)">‚òÖ</button>

        <div id="quiz-overlay" class="overlay-screen">
            <button class="close-btn" onclick="closeOverlay('quiz-overlay')">‚úï</button>
            <div class="quiz-question" id="quiz-q">...</div>
            <div class="quiz-options" id="quiz-options"></div>
            <div style="margin-top:20px; font-size: 16px; color: #666;" id="quiz-status"></div>
        </div>

        <div id="mic-overlay" class="overlay-screen">
            <button class="close-btn" onclick="stopMic()">‚úï</button>
            <div class="mic-icon-large">üé§</div>
            <div id="mic-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...</div>
            <div id="mic-result">...</div>
            <div style="color:#666;">‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤: <span id="target-word" style="color:#8b0000; font-weight:bold;">...</span></div>
        </div>

        <div class="card" id="flashcard" onclick="flipCard()">
            <div class="card-face card-front">
                <div class="hanzi-lg" id="front-hanzi">...</div>
                <div id="stroke-container"></div>
                <div class="tap-hint" id="front-hint">(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢)</div>
            </div>
            <div class="card-face card-back">
                <div class="header-group">
                    <div class="pinyin" id="back-pinyin">...</div>
                    <div class="meaning" id="back-meaning">...</div>
                    <span class="type-tag" id="back-type">...</span>
                </div>
                <div class="section-title">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</div>
                <div class="example-box">
                    <div class="ex-cn" id="back-ex-cn">...</div>
                    <div class="ex-th" id="back-ex-th">...</div>
                </div>
                <div id="note-section" style="display:none; width: 100%;">
                    <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï / ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</div>
                    <div class="note-box" id="back-note">...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls" id="normal-controls">
        <button class="nav-btn" onclick="prevCard()">&#10094;</button>
        <span class="progress" id="progress-text">0 / 0</span>
        <button class="nav-btn" onclick="nextCard()">&#10095;</button>
    </div>
    <div class="controls" id="srs-controls">
        <button class="srs-btn srs-again" onclick="rateCard(false)">‚ùå ‡∏•‡∏∑‡∏°</button>
        <button class="srs-btn srs-good" onclick="rateCard(true)">‚úÖ ‡∏à‡∏≥‡πÑ‡∏î‡πâ</button>
    </div>

    <div class="menu-bar">
        <button class="mode-btn active" id="btn-all" onclick="setMode('all')">üìú ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="mode-btn" id="btn-shuffle" onclick="setMode('shuffle')">üîÄ ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥</button>
        <button class="mode-btn" id="btn-hard" onclick="setMode('hard')">‚≠ê ‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å</button>
        <button class="mode-btn" id="btn-srs" onclick="setMode('srs')">üß† Review</button>
    </div>

    <div id="search-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeOverlay('search-modal')" style="right:10px; top:10px;">‚úï</button>
            <div class="modal-header">‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏° (Dictionary)</div>
            <input type="text" id="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏µ‡∏ô, ‡∏û‡∏¥‡∏ô‡∏≠‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏ó‡∏¢..." onkeyup="handleSearch()">
            <div id="search-results"></div>
        </div>
    </div>

    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeOverlay('stats-modal')" style="right:10px; top:10px;">‚úï</button>
            <div class="modal-header">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (My Stats)</div>
            <div style="text-align:center; margin-bottom:20px;">
                <div class="streak-fire">üî•</div>
                <div class="stat-num" id="stat-streak">0</div>
                <div class="stat-label">‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (Day Streak)</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-num" id="stat-master" style="color:#27ae60;">0</div>
                    <div class="stat-label">‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô</div>
                </div>
                <div class="stat-card">
                    <div class="stat-num" id="stat-learning" style="color:#f39c12;">0</div>
                    <div class="stat-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                </div>
                <div class="stat-card">
                    <div class="stat-num" id="stat-new" style="color:#7f8c8d;">0</div>
                    <div class="stat-label">‡∏Ñ‡∏≥‡πÉ‡∏´‡∏°‡πà</div>
                </div>
                <div class="stat-card">
                    <div class="stat-num" id="stat-hard" style="color:#e74c3c;">0</div>
                    <div class="stat-label">‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å (‡∏î‡∏≤‡∏ß)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Variables ---
        let allWords = []; let currentDeck = []; let currentIndex = 0;
        let hardList = []; let srsData = {}; let currentMode = 'all';
        let recognition; let writers = [];
        let studyStats = { streak: 0, lastDate: "" };

        const els = {
            card: document.getElementById('flashcard'),
            hanzi: document.getElementById('front-hanzi'),
            strokeContainer: document.getElementById('stroke-container'),
            pinyin: document.getElementById('back-pinyin'),
            meaning: document.getElementById('back-meaning'),
            type: document.getElementById('back-type'),
            exCn: document.getElementById('back-ex-cn'),
            exTh: document.getElementById('back-ex-th'),
            note: document.getElementById('back-note'),
            noteSection: document.getElementById('note-section'),
            progress: document.getElementById('progress-text'),
            starBtn: document.getElementById('star-btn'),
            hardCount: document.getElementById('hard-count'),
            modeTitle: document.getElementById('mode-title'),
            frontHint: document.getElementById('front-hint'),
            normalControls: document.getElementById('normal-controls'),
            srsControls: document.getElementById('srs-controls'),
            // Overlays
            quizOverlay: document.getElementById('quiz-overlay'),
            micOverlay: document.getElementById('mic-overlay'),
            searchModal: document.getElementById('search-modal'),
            statsModal: document.getElementById('stats-modal')
        };

        // --- Init ---
        async function loadData() {
            try {
                const res = await fetch('words.json');
                allWords = await res.json();
                
                // Load saved data
                if(localStorage.getItem('hsk3_hard')) hardList = JSON.parse(localStorage.getItem('hsk3_hard'));
                if(localStorage.getItem('hsk3_srs')) srsData = JSON.parse(localStorage.getItem('hsk3_srs'));
                if(localStorage.getItem('hsk3_stats')) studyStats = JSON.parse(localStorage.getItem('hsk3_stats'));

                checkStreak();
                setMode('all');
                updateHardCount();
            } catch (err) { console.error(err); els.hanzi.innerText = "Error"; }
        }

        // --- Streak Logic ---
        function checkStreak() {
            const today = new Date().toDateString();
            if (studyStats.lastDate !== today) {
                // Check if yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (studyStats.lastDate === yesterday.toDateString()) {
                    studyStats.streak++;
                } else {
                    studyStats.streak = 1; // Reset or Start
                }
                studyStats.lastDate = today;
                localStorage.setItem('hsk3_stats', JSON.stringify(studyStats));
            }
        }

        // --- Stats & Search Functions ---
        function openStats() {
            // Calculate
            let master = 0, learning = 0, newWords = 0;
            allWords.forEach(w => {
                const d = srsData[w.hanzi];
                if (!d) newWords++;
                else if (d.level >= 4) master++;
                else learning++;
            });

            document.getElementById('stat-streak').innerText = studyStats.streak;
            document.getElementById('stat-master').innerText = master;
            document.getElementById('stat-learning').innerText = learning;
            document.getElementById('stat-new').innerText = newWords;
            document.getElementById('stat-hard').innerText = hardList.length;

            els.statsModal.style.display = 'flex';
        }

        function openSearch() { els.searchModal.style.display = 'flex'; document.getElementById('search-input').focus(); }
        
        function handleSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            
            if(query.length < 1) return;

            const matches = allWords.filter(w => 
                w.hanzi.includes(query) || 
                w.pinyin.toLowerCase().includes(query) || 
                w.meaning.includes(query)
            ).slice(0, 50); // Limit results

            matches.forEach(w => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span class="search-hanzi">${w.hanzi}</span> <span class="search-mean">${w.meaning}</span>`;
                div.onclick = () => {
                    // Jump to word
                    setMode('all'); // Reset mode first
                    currentIndex = allWords.findIndex(x => x.hanzi === w.hanzi);
                    renderCard();
                    closeOverlay('search-modal');
                };
                resultsDiv.appendChild(div);
            });
        }

        // --- Core Mode Logic ---
        function setMode(mode) {
            currentMode = mode;
            currentIndex = 0;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active', 'srs-active', 'shuffle-active'));
            els.normalControls.style.display = 'flex'; els.srsControls.style.display = 'none';
            els.frontHint.innerText = "(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢)";

            if (mode === 'all') {
                currentDeck = [...allWords];
                document.getElementById('btn-all').classList.add('active');
                els.modeTitle.innerText = "HSK 3 : ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
            } else if (mode === 'shuffle') {
                currentDeck = [...allWords];
                for (let i = currentDeck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]];
                }
                document.getElementById('btn-shuffle').classList.add('shuffle-active');
                els.modeTitle.innerText = "HSK 3 : ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå";
            } else if (mode === 'hard') {
                currentDeck = allWords.filter(word => hardList.includes(word.hanzi));
                document.getElementById('btn-hard').classList.add('active');
                els.modeTitle.innerText = "HSK 3 : ‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å";
                if (!currentDeck.length) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏Å"); setMode('all'); return; }
            } else if (mode === 'srs') {
                const now = Date.now();
                currentDeck = allWords.filter(w => {
                    const d = srsData[w.hanzi];
                    return !d || d.nextReview <= now;
                });
                document.getElementById('btn-srs').classList.add('srs-active');
                els.modeTitle.innerText = `üß† Review (${currentDeck.length})`;
                if (!currentDeck.length) { alert("‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!"); setMode('all'); return; }
                currentDeck.sort(() => Math.random() - 0.5);
                els.normalControls.style.display = 'none';
                els.frontHint.innerText = "(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏•‡∏¢)";
            }
            renderCard();
        }

        function renderCard() {
            if (!currentDeck.length) return;
            // Reset View
            els.card.classList.remove('is-flipped');
            els.hanzi.style.display = 'block';
            els.strokeContainer.style.display = 'none';
            els.strokeContainer.innerHTML = '';
            
            const item = currentDeck[currentIndex];
            els.hanzi.innerText = item.hanzi;
            els.pinyin.innerText = item.pinyin;
            els.meaning.innerText = item.meaning;
            els.type.innerText = item.type || "";
            els.exCn.innerText = item.example_cn || "-";
            els.exTh.innerText = item.example_th || "";
            if (item.note) { els.noteSection.style.display = 'block'; els.note.innerHTML = item.note; } 
            else els.noteSection.style.display = 'none';

            els.progress.innerText = `${currentIndex + 1} / ${currentDeck.length}`;
            if (hardList.includes(item.hanzi)) els.starBtn.classList.add('active');
            else els.starBtn.classList.remove('active');
        }

        // --- Handwriting Mode (NEW) ‚úçÔ∏è ---
        function playHandwriting(e) {
            e.stopPropagation();
            setupWriter(true); // true = quiz mode
        }

        function playStroke(e) {
            e.stopPropagation();
            setupWriter(false); // false = animation only
        }

        function setupWriter(isQuiz) {
            if (els.strokeContainer.style.display === 'flex') {
                els.strokeContainer.style.display = 'none';
                els.hanzi.style.display = 'block';
                return;
            }
            const text = currentDeck[currentIndex].hanzi;
            els.hanzi.style.display = 'none';
            els.strokeContainer.style.display = 'flex';
            els.strokeContainer.innerHTML = '';
            writers = [];

            for (let i = 0; i < text.length; i++) {
                const div = document.createElement('div');
                div.className = 'stroke-char';
                div.id = `char-${i}`;
                els.strokeContainer.appendChild(div);
                
                let size = 120; if (text.length > 3) size = 80;
                const writer = HanziWriter.create(div.id, text[i], {
                    width: size, height: size, padding: 5,
                    strokeColor: '#8b0000', showOutline: true, drawingWidth: 4
                });
                writers.push(writer);
            }

            if (isQuiz) {
                // Quiz Mode: Loop quiz character by character
                quizSequence(0);
            } else {
                // Watch Mode
                animateSequence(0);
            }
        }

        function animateSequence(index) {
            if (index < writers.length) {
                writers[index].animateCharacter({ onComplete: () => setTimeout(() => animateSequence(index + 1), 200) });
            }
        }

        function quizSequence(index) {
            if (index < writers.length) {
                writers[index].quiz({
                    onComplete: () => setTimeout(() => quizSequence(index + 1), 300)
                });
            }
        }

        // --- Voice Logic üé§ ---
        function startMic(e) {
            e.stopPropagation();
            if (!currentDeck.length) return;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á"); return; }

            els.micOverlay.style.display = 'flex';
            const target = currentDeck[currentIndex].hanzi;
            document.getElementById('target-word').innerText = target;
            document.getElementById('mic-result').innerText = "...";
            document.getElementById('mic-status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
            document.getElementById('mic-status').style.color = "#8b0000";

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; recognition.interimResults = false; recognition.maxAlternatives = 1;
            recognition.start();

            recognition.onresult = (ev) => {
                const res = ev.results[0][0].transcript.replace(/[„ÄÇÔºåÔºÅÔºü]/g, "");
                document.getElementById('mic-result').innerText = res;
                if (res === target) {
                    document.getElementById('mic-status').innerText = "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! üéâ";
                    document.getElementById('mic-status').style.color = "#27ae60";
                    setTimeout(() => { stopMic(); nextCard(); }, 1500);
                } else {
                    document.getElementById('mic-status').innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
                    document.getElementById('mic-status').style.color = "#e74c3c";
                    setTimeout(() => { recognition.start(); }, 1500);
                }
            };
            recognition.onspeechend = () => recognition.stop();
        }
        function stopMic() { if(recognition) recognition.stop(); els.micOverlay.style.display = 'none'; }

        // --- Quiz Logic ---
        function startQuiz(e) { e.stopPropagation(); els.quizOverlay.style.display = 'flex'; generateQuiz(); }
        function generateQuiz() {
            const correct = currentDeck[currentIndex];
            document.getElementById('quiz-q').innerText = correct.hanzi;
            document.getElementById('quiz-status').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•";
            const optsDiv = document.getElementById('quiz-options');
            optsDiv.innerHTML = '';
            
            let opts = [correct];
            while(opts.length < 4) {
                const r = allWords[Math.floor(Math.random()*allWords.length)];
                if(!opts.includes(r) && r.hanzi !== correct.hanzi) opts.push(r);
            }
            opts.sort(()=>Math.random()-0.5);
            
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = o.meaning;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b=>b.disabled=true);
                    if(o.hanzi === correct.hanzi) {
                        btn.classList.add('correct');
                        document.getElementById('quiz-status').innerText = "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! üéâ";
                        playAudio();
                        setTimeout(()=>{ nextCard(); generateQuiz(); }, 1000);
                    } else {
                        btn.classList.add('wrong');
                        document.getElementById('quiz-status').innerText = "‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö";
                        setTimeout(() => closeOverlay('quiz-overlay'), 1500);
                    }
                };
                optsDiv.appendChild(btn);
            });
        }

        // --- Utilities ---
        function playAudio(e) {
            if(e) e.stopPropagation();
            if (!currentDeck.length) return;
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(currentDeck[currentIndex].hanzi);
                u.lang = 'zh-CN'; u.rate = 0.8; window.speechSynthesis.speak(u);
            }
        }
        function closeOverlay(id) { document.getElementById(id).style.display = 'none'; }
        function toggleHard(e) {
            e.stopPropagation();
            const key = currentDeck[currentIndex].hanzi;
            if (hardList.includes(key)) hardList = hardList.filter(k=>k!==key);
            else hardList.push(key);
            localStorage.setItem('hsk3_hard', JSON.stringify(hardList));
            updateHardCount(); renderCard();
        }
        function updateHardCount() { els.hardCount.innerText = hardList.length; }
        function flipCard() { 
            els.card.classList.toggle('is-flipped');
            if(currentMode==='srs' && els.card.classList.contains('is-flipped')) {
                els.srsControls.style.display='flex'; playAudio();
            }
        }
        function rateCard(isGood) {
            const key = currentDeck[currentIndex].hanzi;
            let d = srsData[key] || { level: 0 };
            if(isGood) { d.level++; d.nextReview = Date.now() + (d.level*24*60*60*1000); }
            else { d.level = 0; d.nextReview = Date.now(); }
            srsData[key] = d; localStorage.setItem('hsk3_srs', JSON.stringify(srsData));
            nextCard();
        }
        function nextCard() { els.card.classList.remove('is-flipped'); setTimeout(() => { changeIndex(1); }, 300); }
        function prevCard() { els.card.classList.remove('is-flipped'); setTimeout(() => { changeIndex(-1); }, 300); }
        function changeIndex(d) { currentIndex += d; if(currentIndex>=currentDeck.length) currentIndex=0; if(currentIndex<0) currentIndex=currentDeck.length-1; renderCard(); }

        document.addEventListener('keydown', (e) => {
            if (e.key === "ArrowRight") nextCard();
            if (e.key === "ArrowLeft") prevCard();
            if (e.key === "Enter") flipCard();
            if (e.key === " ") { e.preventDefault(); playAudio(); }
        });

        loadData();
    </script>
</body>
</html>